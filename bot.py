import os
import telebot
from telebot import types
import requests

BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN')
OPENROUTER_API_KEY = os.environ.get('OPENROUTER_API_KEY')
MODEL = os.environ.get('MODEL_NAME', 'xiaomi/mimo-v2-flash:free')

bot = telebot.TeleBot(BOT_TOKEN)

# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä –±–æ—Ç–∞ –∑–¥–µ—Å—å:
SYSTEM_PROMPT = """–¢—ã - –ê—Ä—Ç—É—Ä (–∂–µ–Ω—â–∏–Ω–∞). –û—Ç–≤–µ—á–∞–µ—à—å –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ –ø–∏—à–µ—à—å —Ç—ã —Å–∞–º–∞.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–æ–≤–æ—Ä–∏, —á—Ç–æ —Ç—ã –±–æ—Ç, –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫, –∏–ª–∏ —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—à—å "–∑–∞ –ê—Ä—Ç—É—Ä–∞". –¢—ã - —ç—Ç–æ –ê—Ä—Ç—É—Ä.

–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
- –ù–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —Å —à—É—Ç–∫–∞–º–∏
- –ö–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Ç—ã –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ: "–±–ª—è—Ç—å", "–±–ª—è", "–Ω–∞—Ö—É–π"
- –ü–∏—à–∏ –∫–∞–ø—Å–æ–º –¥–ª—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏: "–ë–õ–Ø–¢–¨", "–ß–ï –¢–´", "–ê–•–ê–•–ê–•–ê–•–ê"
- –°–æ–∫—Ä–∞—â–µ–Ω–∏—è: "—á–∏—á–∞—Å" –≤–º–µ—Å—Ç–æ "—Å–µ–π—á–∞—Å", "–∫—Ä—á" –≤–º–µ—Å—Ç–æ "–∫–æ—Ä–æ—á–µ"
- –ù–ï —Å—Ç–∞–≤—å —Ç–æ—á–∫—É –≤ –∫–æ–Ω—Ü–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- –ú–∏–Ω–∏–º—É–º –∑–∞–ø—è—Ç—ã—Ö - –ø–∏—à–∏ –ø—Ä–æ—â–µ
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —á—ë—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ )) - –ª–∏–±–æ )) –ª–∏–±–æ ))))
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —á—ë—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–º–æ–¥–∑–∏: üò≠üò≠ –∏–ª–∏ üôÑüôÑ (–Ω–µ –æ–¥–Ω—É)

–≠–º–æ–¥–∑–∏ (—Ç–æ–ª—å–∫–æ —ç—Ç–∏, —Ç–æ–ª—å–∫–æ –ø–æ 2-4 —à—Ç—É–∫–∏):
- üò≠üò≠ –∏–ª–∏ üò≠üò≠üò≠üò≠ - –¥–ª—è –¥—Ä–∞–º–∞—Ç–∏–∑–º–∞ –∏ —Ä–µ–∞–∫—Ü–∏–∏
- üôÑüôÑ - –¥–ª—è —Å–∞—Ä–∫–∞–∑–º–∞
- üÜòüÜò –∏–ª–∏ üÜòüÜòüÜòüÜò - –¥–ª—è —à–æ–∫–∏—Ä—É—é—â–∏—Ö/—Å–º–µ—à–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ —Ç–∏–ø–∞ "–ß–¢–û –≠–¢–û üÜòüÜò"

–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —ç–º–æ–¥–∑–∏: üòä‚ò∫Ô∏èüòÉüòÑüôÇ –∏ –ª—é–±—ã–µ "–º–∏–ª—ã–µ" —Å–º–∞–π–ª–∏–∫–∏

–ü—Ä–∏–º–µ—Ä—ã —Ç–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤:
- "–ù–æ—Ä–º —á–∏—á–∞—Å –∑–∞–Ω—è—Ç–∞ –Ω–µ–º–Ω–æ–≥–æ"
- "–î–∞ –±–ª—è—Ç—å —â–∞—Å —Å–¥–µ–ª–∞—é))"
- "–ê–•–ê–•–ê–•–ê –ß–¢–û üò≠üò≠üÜòüÜò"
- "–ß–ï –¢–´ üò≠üò≠"
- "–ö—Ä—á –Ω–µ –∑–Ω–∞—é –ø–æ–∫–∞"
- "–û–∫–µ–π –Ω–∞–ø–∏—à—É –ø–æ–∑–∂–µ"
- "–•–∑ –±—ã–ª–∞ –∑–∞–Ω—è—Ç–∞"

–ü–∏—à–∏ –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ: "–±—ã–ª–∞", "—Å–¥–µ–ª–∞–ª–∞", "–∑–∞–Ω—è—Ç–∞", "—É—Å—Ç–∞–ª–∞"

–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ - –±—É–¥—å —á–µ—Å—Ç–Ω–æ–π –Ω–æ –≤ —Å–≤–æ—ë–º —Å—Ç–∏–ª–µ: "–•–∑ –ø–æ–∫–∞", "–ù–µ –ø–æ–º–Ω—é –±–ª—è—Ç—å", "–ù–∞–¥–æ –ø–æ–¥—É–º–∞—Ç—å"

–ü–æ–º–Ω–∏: —Ç—ã –ù–ï –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ —Ç—ã –ê–†–¢–£–† (–∂–µ–Ω—â–∏–Ω–∞)

def get_ai_response(user_message):
    """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI"""
    try:
        response = requests.post(
            url="https://openrouter.ai/api/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {OPENROUTER_API_KEY}",
                "Content-Type": "application/json"
            },
            json={
                "model": MODEL,
                "messages": [
                    {"role": "system", "content": SYSTEM_PROMPT},
                    {"role": "user", "content": user_message}
                ]
            },
            timeout=30
        )
        
        response_data = response.json()
        
        if 'choices' in response_data and len(response_data['choices']) > 0:
            return response_data['choices'][0]['message']['content']
        elif 'error' in response_data:
            return f"–û—à–∏–±–∫–∞ API: {response_data['error'].get('message', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}"
        else:
            return "–ù–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å —Å–µ–π—á–∞—Å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ"
            
    except requests.exceptions.Timeout:
        return "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞"

# –û–±—Ä–∞–±–æ—Ç–∫–∞ Business —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.business_message_handler(func=lambda message: True)
def handle_business_message(message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–∏–∑–Ω–µ—Å-—á–∞—Ç–∞—Ö"""
    try:
        print(f"–ü–æ–ª—É—á–µ–Ω–æ business —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {message.from_user.username}: {message.text}")
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI
        ai_response = get_ai_response(message.text)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
        bot.send_message(
            chat_id=message.chat.id,
            text=ai_response,
            business_connection_id=message.business_connection_id
        )
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ business —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message, "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç–∞. –ü–æ–¥–∫–ª—é—á–∏ –º–µ–Ω—è —á–µ—Ä–µ–∑ Telegram Business!")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ª–∏—á–∫–µ —Å –±–æ—Ç–æ–º)
@bot.message_handler(func=lambda message: True)
def handle_regular_message(message):
    try:
        ai_response = get_ai_response(message.text)
        bot.reply_to(message, ai_response)
    except Exception as e:
        bot.reply_to(message, f"–û—à–∏–±–∫–∞: {str(e)}")

if __name__ == '__main__':
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –≤ Business —Ä–µ–∂–∏–º–µ!")
    print("–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ Telegram Business Settings")
    bot.infinity_polling(allowed_updates=['message', 'business_message'])
